{-# LANGUAGE RecordWildCards #-}
{-# LANGUAGE OverloadedStrings #-}

module Network.SSH.Transport where

import           Control.Monad ( guard, msum, unless )
import qualified Data.ByteString as S
import           Data.Char ( chr, ord )
import           Data.List ( intersperse )
import           Data.Serialize
                     ( Get, Putter, getWord8, putWord8, putByteString, label
                     , putWord32be, getWord32be, isolate, getBytes, remaining
                     , lookAhead, skip, runPut )
import           Data.Word ( Word8, Word32 )

import Debug.Trace


data SshIdent = SshIdent { sshProtoVersion
                         , sshSoftwareVersion
                         , sshComments        :: !S.ByteString
                         } deriving (Show)

-- | Always 16 bytes of random data.
newtype SshCookie = SshCookie S.ByteString
                    deriving (Show)

data SshAlgs = SshAlgs { sshClientToServer :: [S.ByteString]
                       , sshServerToClient :: [S.ByteString]
                       } deriving (Show)

data SshKeyExchange = SshKeyExchange { sshCookie            :: !SshCookie
                                     , sshKexAlgs           :: [S.ByteString]
                                     , sshServerHostKeyAlgs :: [S.ByteString]
                                     , sshEncAlgs           :: !SshAlgs
                                     , sshMacAlgs           :: !SshAlgs
                                     , sshCompAlgs          :: !SshAlgs
                                     , sshLanguages         :: !SshAlgs
                                     , sshFirstKexFollows   :: Bool
                                     } deriving (Show)


ssh_MSG_KEXINIT :: Word8
ssh_MSG_KEXINIT  = 20


-- Rendering -------------------------------------------------------------------

putSshIdent :: Putter SshIdent
putSshIdent SshIdent { .. } =
  do putByteString "SSH-"
     putByteString sshProtoVersion
     putByteString "-"
     putByteString sshSoftwareVersion
     unless (S.null sshComments) $
       do putByteString " "
          putByteString sshComments
     putByteString "\r\n"

putSshCookie :: Putter SshCookie
putSshCookie (SshCookie bytes) =
     putByteString bytes

putNameList :: Putter [S.ByteString]
putNameList names =
  do let len | null names = 0
             | otherwise  = sum (map S.length names)
                          + length names - 1 -- commas
     putWord32be (fromIntegral len)
     mapM_ putByteString (intersperse "," names)

putSshAlgs :: Putter SshAlgs
putSshAlgs SshAlgs { .. } =
  do putNameList sshClientToServer
     putNameList sshServerToClient

-- | Given a way to render something, turn it into an ssh packet.
--
-- XXX this needs to take into account the block algorithm, and potential mac.
putSshPacket :: Maybe Int -> Putter a -> Putter a
putSshPacket mbCbSize render a =
  do putWord32be (fromIntegral bytesLen)
     putWord8 (fromIntegral paddingLen)
     putByteString bytes
     putByteString padding
  where
  bytes    = runPut (render a)
  bytesLen = S.length bytes

  align = case mbCbSize of
            Just cbSize -> max cbSize 8
            otherwise   -> 8

  bytesRem   = bytesLen `mod` align
  paddingLen | bytesRem == 0 = 0
             | otherwise     = align - bytesRem

  padding = S.replicate paddingLen 0x0

putSshKeyExchange :: Putter SshKeyExchange
putSshKeyExchange SshKeyExchange { .. } =
  do putWord8 ssh_MSG_KEXINIT
     putSshCookie sshCookie
     putNameList sshServerHostKeyAlgs
     putSshAlgs sshEncAlgs
     putSshAlgs sshMacAlgs
     putSshAlgs sshCompAlgs
     putSshAlgs sshLanguages
     putWord8 $ if sshFirstKexFollows
                   then 1
                   else 0
     -- RESERVED
     putWord32be 0

-- Parsing ---------------------------------------------------------------------

getCrLf :: Get ()
getCrLf  =
  do cr <- getWord8
     lf <- getWord8
     guard (cr == 13 && lf == 10)

getCh :: Char -> Get ()
getCh c =
  do c' <- getWord8
     guard (c == chr (fromIntegral c'))

getBytesUntil :: Get () -> Get S.ByteString
getBytesUntil end =
  do start      <- remaining
     (off,stop) <- lookAhead (go 0)
     traceShowM (start,off,stop)
     bytes      <- getBytes off
     -- skip the length of the ending action
     skip (start - (stop + off))
     return bytes
  where
  go off = msum [ do end
                     stop <- remaining
                     return (off, stop)
                , do _ <- getWord8
                     go $! off + 1
                ]

getSshIdent :: Get SshIdent
getSshIdent  = label "SshIdent" $
  do "SSH"              <- getBytesUntil (getCh '-')
     sshProtoVersion    <- getBytesUntil (getCh '-')

     msum [ do sshSoftwareVersion <- getBytesUntil (getCh ' ')
               sshComments        <- getBytesUntil  getCrLf
               return SshIdent { .. }
          , do sshSoftwareVersion <- getBytesUntil  getCrLf
               let sshComments = ""
               return SshIdent { .. }
          ]

getSshCookie :: Get SshCookie
getSshCookie  = SshCookie `fmap` getBytes 16

getNameList :: Get [S.ByteString]
getNameList  =
  do len   <- getWord32be
     bytes <- getBytes (fromIntegral len)
     return (S.splitWith (== comma) bytes)
  where
  comma = fromIntegral (ord ',')

getSshAlgs :: Get SshAlgs
getSshAlgs  =
  do sshClientToServer <- getNameList
     sshServerToClient <- getNameList
     return SshAlgs { .. }

-- | Given a way to parse the payload of an ssh packet, do the required
-- book-keeping surrounding the data.
getSshPacket :: Maybe Int -> Get a -> Get (a,S.ByteString)
getSshPacket mbCbSize getPayload =
  do -- XXX verify that packetLen is reasonable.  The rfc requires that
     -- it be able to handle at least 35000.
     packetLen  <- getWord32be
     paddingLen <- getWord8

     let payloadLen = fromIntegral packetLen - fromIntegral paddingLen - 1
     payload <- isolate payloadLen getPayload

     skip (fromIntegral paddingLen)

     mac <- getBytes =<< remaining

     return (payload, mac)

getSshKeyExchange :: Get SshKeyExchange
getSshKeyExchange  = label "SshKeyExchange" $
  do tag <- getWord8
     guard (tag == ssh_MSG_KEXINIT)

     sshCookie            <- label "sshCookie"            getSshCookie
     sshKexAlgs           <- label "sshKexAlgs"           getNameList
     sshServerHostKeyAlgs <- label "sshServerHostKeyAlgs" getNameList
     sshEncAlgs           <- label "sshEncAlgs"           getSshAlgs
     sshMacAlgs           <- label "sshMacAlgs"           getSshAlgs
     sshCompAlgs          <- label "sshCompAlgs"          getSshAlgs
     sshLanguages         <- label "sshLanguages"         getSshAlgs
     byte                 <- label "sshFirstKexFollows"   getWord8
     let sshFirstKexFollows | byte == 0 = False
                            | otherwise = True

     -- RESERVED
     _ <- getWord32be

     return SshKeyExchange { .. }


testKeyExchange :: S.ByteString
testKeyExchange  = S.pack
  [0x00,0x00,0x06,0x34,0x06,0x14,0x9b,0xe7,0x84,0xbf,0x67,0x8f,0x21,0x6f,0xe7,0x6f
  ,0x93,0x3f,0x61,0x58,0x98,0x2b,0x00,0x00,0x00,0x7e,0x64,0x69,0x66,0x66,0x69,0x65
  ,0x2d,0x68,0x65,0x6c,0x6c,0x6d,0x61,0x6e,0x2d,0x67,0x72,0x6f,0x75,0x70,0x2d,0x65
  ,0x78,0x63,0x68,0x61,0x6e,0x67,0x65,0x2d,0x73,0x68,0x61,0x32,0x35,0x36,0x2c,0x64
  ,0x69,0x66,0x66,0x69,0x65,0x2d,0x68,0x65,0x6c,0x6c,0x6d,0x61,0x6e,0x2d,0x67,0x72
  ,0x6f,0x75,0x70,0x2d,0x65,0x78,0x63,0x68,0x61,0x6e,0x67,0x65,0x2d,0x73,0x68,0x61
  ,0x31,0x2c,0x64,0x69,0x66,0x66,0x69,0x65,0x2d,0x68,0x65,0x6c,0x6c,0x6d,0x61,0x6e
  ,0x2d,0x67,0x72,0x6f,0x75,0x70,0x31,0x34,0x2d,0x73,0x68,0x61,0x31,0x2c,0x64,0x69
  ,0x66,0x66,0x69,0x65,0x2d,0x68,0x65,0x6c,0x6c,0x6d,0x61,0x6e,0x2d,0x67,0x72,0x6f
  ,0x75,0x70,0x31,0x2d,0x73,0x68,0x61,0x31,0x00,0x00,0x00,0x83,0x73,0x73,0x68,0x2d
  ,0x72,0x73,0x61,0x2d,0x63,0x65,0x72,0x74,0x2d,0x76,0x30,0x31,0x40,0x6f,0x70,0x65
  ,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x73,0x73,0x68,0x2d,0x72,0x73,0x61
  ,0x2d,0x63,0x65,0x72,0x74,0x2d,0x76,0x30,0x30,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73
  ,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x73,0x73,0x68,0x2d,0x72,0x73,0x61,0x2c,0x73,0x73
  ,0x68,0x2d,0x64,0x73,0x73,0x2d,0x63,0x65,0x72,0x74,0x2d,0x76,0x30,0x31,0x40,0x6f
  ,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x73,0x73,0x68,0x2d,0x64
  ,0x73,0x73,0x2d,0x63,0x65,0x72,0x74,0x2d,0x76,0x30,0x30,0x40,0x6f,0x70,0x65,0x6e
  ,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x73,0x73,0x68,0x2d,0x64,0x73,0x73,0x00
  ,0x00,0x00,0xcb,0x61,0x65,0x73,0x31,0x32,0x38,0x2d,0x63,0x74,0x72,0x2c,0x61,0x65
  ,0x73,0x31,0x39,0x32,0x2d,0x63,0x74,0x72,0x2c,0x61,0x65,0x73,0x32,0x35,0x36,0x2d
  ,0x63,0x74,0x72,0x2c,0x61,0x72,0x63,0x66,0x6f,0x75,0x72,0x32,0x35,0x36,0x2c,0x61
  ,0x72,0x63,0x66,0x6f,0x75,0x72,0x31,0x32,0x38,0x2c,0x61,0x65,0x73,0x31,0x32,0x38
  ,0x2d,0x67,0x63,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d
  ,0x2c,0x61,0x65,0x73,0x32,0x35,0x36,0x2d,0x67,0x63,0x6d,0x40,0x6f,0x70,0x65,0x6e
  ,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x61,0x65,0x73,0x31,0x32,0x38,0x2d,0x63
  ,0x62,0x63,0x2c,0x33,0x64,0x65,0x73,0x2d,0x63,0x62,0x63,0x2c,0x62,0x6c,0x6f,0x77
  ,0x66,0x69,0x73,0x68,0x2d,0x63,0x62,0x63,0x2c,0x63,0x61,0x73,0x74,0x31,0x32,0x38
  ,0x2d,0x63,0x62,0x63,0x2c,0x61,0x65,0x73,0x31,0x39,0x32,0x2d,0x63,0x62,0x63,0x2c
  ,0x61,0x65,0x73,0x32,0x35,0x36,0x2d,0x63,0x62,0x63,0x2c,0x61,0x72,0x63,0x66,0x6f
  ,0x75,0x72,0x2c,0x72,0x69,0x6a,0x6e,0x64,0x61,0x65,0x6c,0x2d,0x63,0x62,0x63,0x40
  ,0x6c,0x79,0x73,0x61,0x74,0x6f,0x72,0x2e,0x6c,0x69,0x75,0x2e,0x73,0x65,0x00,0x00
  ,0x00,0xcb,0x61,0x65,0x73,0x31,0x32,0x38,0x2d,0x63,0x74,0x72,0x2c,0x61,0x65,0x73
  ,0x31,0x39,0x32,0x2d,0x63,0x74,0x72,0x2c,0x61,0x65,0x73,0x32,0x35,0x36,0x2d,0x63
  ,0x74,0x72,0x2c,0x61,0x72,0x63,0x66,0x6f,0x75,0x72,0x32,0x35,0x36,0x2c,0x61,0x72
  ,0x63,0x66,0x6f,0x75,0x72,0x31,0x32,0x38,0x2c,0x61,0x65,0x73,0x31,0x32,0x38,0x2d
  ,0x67,0x63,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c
  ,0x61,0x65,0x73,0x32,0x35,0x36,0x2d,0x67,0x63,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73
  ,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x61,0x65,0x73,0x31,0x32,0x38,0x2d,0x63,0x62
  ,0x63,0x2c,0x33,0x64,0x65,0x73,0x2d,0x63,0x62,0x63,0x2c,0x62,0x6c,0x6f,0x77,0x66
  ,0x69,0x73,0x68,0x2d,0x63,0x62,0x63,0x2c,0x63,0x61,0x73,0x74,0x31,0x32,0x38,0x2d
  ,0x63,0x62,0x63,0x2c,0x61,0x65,0x73,0x31,0x39,0x32,0x2d,0x63,0x62,0x63,0x2c,0x61
  ,0x65,0x73,0x32,0x35,0x36,0x2d,0x63,0x62,0x63,0x2c,0x61,0x72,0x63,0x66,0x6f,0x75
  ,0x72,0x2c,0x72,0x69,0x6a,0x6e,0x64,0x61,0x65,0x6c,0x2d,0x63,0x62,0x63,0x40,0x6c
  ,0x79,0x73,0x61,0x74,0x6f,0x72,0x2e,0x6c,0x69,0x75,0x2e,0x73,0x65,0x00,0x00,0x01
  ,0x92,0x68,0x6d,0x61,0x63,0x2d,0x6d,0x64,0x35,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70
  ,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73
  ,0x68,0x61,0x31,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e
  ,0x63,0x6f,0x6d,0x2c,0x75,0x6d,0x61,0x63,0x2d,0x36,0x34,0x2d,0x65,0x74,0x6d,0x40
  ,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x75,0x6d,0x61,0x63
  ,0x2d,0x31,0x32,0x38,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68
  ,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x32,0x2d,0x32
  ,0x35,0x36,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63
  ,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x32,0x2d,0x35,0x31,0x32
  ,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d
  ,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x72,0x69,0x70,0x65,0x6d,0x64,0x31,0x36,0x30,0x2d
  ,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c
  ,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x31,0x2d,0x39,0x36,0x2d,0x65,0x74,0x6d
  ,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61
  ,0x63,0x2d,0x6d,0x64,0x35,0x2d,0x39,0x36,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65
  ,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x6d,0x64
  ,0x35,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x31,0x2c,0x75,0x6d,0x61,0x63
  ,0x2d,0x36,0x34,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c
  ,0x75,0x6d,0x61,0x63,0x2d,0x31,0x32,0x38,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68
  ,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x32,0x2d,0x32
  ,0x35,0x36,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x32,0x2d,0x35,0x31,0x32
  ,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x72,0x69,0x70,0x65,0x6d,0x64,0x31,0x36,0x30,0x2c
  ,0x68,0x6d,0x61,0x63,0x2d,0x72,0x69,0x70,0x65,0x6d,0x64,0x31,0x36,0x30,0x40,0x6f
  ,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d
  ,0x73,0x68,0x61,0x31,0x2d,0x39,0x36,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x6d,0x64,0x35
  ,0x2d,0x39,0x36,0x00,0x00,0x01,0x92,0x68,0x6d,0x61,0x63,0x2d,0x6d,0x64,0x35,0x2d
  ,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c
  ,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x31,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70
  ,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x75,0x6d,0x61,0x63,0x2d,0x36
  ,0x34,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f
  ,0x6d,0x2c,0x75,0x6d,0x61,0x63,0x2d,0x31,0x32,0x38,0x2d,0x65,0x74,0x6d,0x40,0x6f
  ,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d
  ,0x73,0x68,0x61,0x32,0x2d,0x32,0x35,0x36,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65
  ,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68
  ,0x61,0x32,0x2d,0x35,0x31,0x32,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73
  ,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x72,0x69,0x70,0x65
  ,0x6d,0x64,0x31,0x36,0x30,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73
  ,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x31,0x2d
  ,0x39,0x36,0x2d,0x65,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63
  ,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x6d,0x64,0x35,0x2d,0x39,0x36,0x2d,0x65
  ,0x74,0x6d,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68
  ,0x6d,0x61,0x63,0x2d,0x6d,0x64,0x35,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61
  ,0x31,0x2c,0x75,0x6d,0x61,0x63,0x2d,0x36,0x34,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73
  ,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x75,0x6d,0x61,0x63,0x2d,0x31,0x32,0x38,0x40,0x6f
  ,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d,0x2c,0x68,0x6d,0x61,0x63,0x2d
  ,0x73,0x68,0x61,0x32,0x2d,0x32,0x35,0x36,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68
  ,0x61,0x32,0x2d,0x35,0x31,0x32,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x72,0x69,0x70,0x65
  ,0x6d,0x64,0x31,0x36,0x30,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x72,0x69,0x70,0x65,0x6d
  ,0x64,0x31,0x36,0x30,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d
  ,0x2c,0x68,0x6d,0x61,0x63,0x2d,0x73,0x68,0x61,0x31,0x2d,0x39,0x36,0x2c,0x68,0x6d
  ,0x61,0x63,0x2d,0x6d,0x64,0x35,0x2d,0x39,0x36,0x00,0x00,0x00,0x1a,0x6e,0x6f,0x6e
  ,0x65,0x2c,0x7a,0x6c,0x69,0x62,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63
  ,0x6f,0x6d,0x2c,0x7a,0x6c,0x69,0x62,0x00,0x00,0x00,0x1a,0x6e,0x6f,0x6e,0x65,0x2c
  ,0x7a,0x6c,0x69,0x62,0x40,0x6f,0x70,0x65,0x6e,0x73,0x73,0x68,0x2e,0x63,0x6f,0x6d
  ,0x2c,0x7a,0x6c,0x69,0x62,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  ,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
